---
title: "scatools"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{scatools}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction
We start by loading `scatools` and `ArchR`, as well as the filepath to an example `fragments.bed.gz` file containing fragments from 100 normal mammary cells. This bed file was generated using the `reformatFragmentFiles()` function from the `ArchR` package.

Note this vignette is currently set up with dummy normal data and is purely intended to demonstrate package functionality. There are no CNV changes in the test data.

## Installation

You can install the development version of scatools from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("mjz1/scatools")
```

## Example

We start by loading `scatools` and `ArchR`, as well as the filepath to an example `fragments.bed.gz` file containing fragments from 100 normal mammary cells. This bed file was generated using the `reformatFragmentFiles()` function from the `ArchR` package.

Note that all steps in this vignette work with a list of fragment files from multiple samples as well.
```{r setup, eval=TRUE, message=FALSE}
library(scatools)
library(ArchR, quietly = TRUE)
library(BSgenome.Hsapiens.UCSC.hg38, quietly = TRUE)
library(patchwork)
library(dittoSeq)
```


```{r, eval=FALSE}
ncores <- 8 # Adjust accordingly
addArchRThreads(ncores)
addArchRGenome("hg38")

fragment_file <- system.file("extdata", "fragments.bed.gz", package = "scatools")
names(fragment_file) <- "test_sample"

# Set up example output directories
arrow_dir = "./example/ArrowFiles"
bindepth_dir = "./example/binned_depth"
scatools_dir = "./example/scatools_analysis"

invisible(lapply(list(arrow_dir, bindepth_dir, scatools_dir), dir.create, showWarnings = FALSE, recursive = TRUE))
```


We first create an ArrowFile from the fragments file using the `ArchR` package. If you already have processed ArrowFiles you can skip to the `scatools` processing steps.
```{r, eval=FALSE}
knitr::opts_chunk$set(root.dir = arrow_dir)

setwd(arrow_dir)

ArrowFiles <- createArrowFiles(
  inputFiles = fragment_file,
  sampleNames = names(fragment_file),
  minTSS = 4, #Dont set this too high because you can always increase later
  minFrags = 1000,
  addTileMat = TRUE,
  addGeneScoreMat = TRUE,
  force = FALSE
)

# Calculate doublet scores
doubScores <- addDoubletScores(
  input = ArrowFiles,
  k = 10, #Refers to how many cells near a "pseudo-doublet" to count.
  knnMethod = "LSI", #Refers to the embedding to use for nearest neighbor search.
  LSIMethod = 1,
  force = FALSE
)

# Create an ArchR project file
proj <- ArchRProject(
  ArrowFiles = ArrowFiles,
  outputDirectory = "./",
  copyArrows = FALSE #This is recommended so that you maintain an unaltered copy for later usage.
)

proj <- filterDoublets(proj)
```

Now we process this data using `scatools`. Helper functions help us to create `GenomicRanges` bins, and compute GC content for downstream usage. Here we demonstrate using 10Mb bins.
```{r}
# Generate bins
bins <- get_tiled_bins(bs_genome = BSgenome.Hsapiens.UCSC.hg38::BSgenome.Hsapiens.UCSC.hg38, tilewidth = 1e7)

bin_name <- prettyMb(getmode(width(bins)))
message(bin_name)

head(bins)
```

Next we bin the atac fragments from the input ArrowFiles.
```{r, eval=FALSE}
# Bin the fragments
bin_atac_frags(ArrowFiles = getArrowFiles(proj), bins = bins, outdir = bindepth_dir, ncores = ncores, overwrite = FALSE, return_mat = FALSE)
```

Then we set up to perform the analysis for all samples
```{r, eval=FALSE}
samples <- file.path(bindepth_dir, bin_name, names(fragment_file))
overwrite <- TRUE
verbose <- TRUE

for (i in seq_along(samples)) {
  samp_dir <- samples[i]
  samp_name <- basename(samp_dir)

  samp_outdir <- file.path(scatools_dir, bin_name, samp_name)

  raw_out <- file.path(samp_outdir, "sce", "01_raw.sce")
  final_out <- file.path(samp_outdir, "sce", "02_hmm.sce")
  hmm_out <- file.path(samp_outdir, "hmm", "hmm_results.rda")

  logger::log_info("Processing sample {i} of {length(samples)}: {samp_name}")
  
  if (file.exists(final_out) & !overwrite) {
    logger::log_info("Final output exists! Skipping to next sample...")
    next
  }

  if (file.exists(raw_out) & !overwrite) {
    logger::log_info("Raw sce object found -- Loading...")
    sce <- get(load(raw_out))
  } else {
    sce <- load_atac_bins(
      samples = samp_dir,
      sample.names = samp_name,
      ArchR_Proj = proj,
      bins = bins,
      BPPARAM = BiocParallel::bpparam(),
      save_to = raw_out,
      verbose = verbose
    )
  }
  
  sce <- sce %>%
    add_ideal_mat(ncores = ncores, verbose = verbose) %>%
    add_gc_cor(method = "modal", verbose = verbose, ncores = ncores) %>%
    add_hmmcopy(verbose = verbose, ncores = ncores, save_raw_hmm = hmm_out)
  
  save_to(object = sce, save_to = final_out)
}
```


```{r, include=FALSE}
# Sideload results
data('test_sce')
sce <- test_sce
```

Use Seurat to cluster and dimensionality reduce
```{r}
sce <- cluster_seurat(sce, assay_name = "counts_gc_modal", resolution = 0.5, do.scale = TRUE, do.center = TRUE, suffix = "", verbose = FALSE)
sce <- calc_cnv_score(sce, assay_name = "counts_gc_modal")
```

Plot the results
```{r}
p1 <- dittoDimPlot(sce, var = "clusters", do.label = TRUE, labels.highlight = FALSE, labels.repel = FALSE)
p2 <- dittoDimPlot(sce, var = "cnv_score", order = "increasing", legend.title = "cnv score")

pcomb <- p1 + p2 + plot_layout(ncol = 2) & theme(aspect.ratio = 1)
pcomb
```

```{r}
dittoPlot(sce, "cnv_score", group.by = "clusters", plots = c("vlnplot", "jitter"), jitter.width = 1, jitter.size = 0.2, x.labels.rotate = FALSE)
```



We can visualize the results as a heatmap.
```{r cnaheatmap_plot, message=FALSE}
ht <- cnaHeatmap(sce, assay_name = "counts_gc_modal", clone_name = "clusters", log2 = TRUE, center = TRUE, scale = "cells", col_fun = logr_col_fun(), col_clones = dittoColors(), border = TRUE)
ht
```


Or plot individual cells
```{r cell_cna_plot}
plot_cell_cna(sce = sce, cell_id = colnames(sce)[1:5], assay_name = "counts_gc_modal")
```
