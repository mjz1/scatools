---
title: "scatools"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{scatools}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction
We start by loading `scatools` and `ArchR`, as well as the filepath to an example `fragments.bed.gz` file containing fragments from 100 normal mammary cells. This bed file was generated using the `reformatFragmentFiles()` function from the `ArchR` package.

Note this vignette is currently set up with dummy normal data and is purely intended to demonstrate package functionality. There are no CNV changes in the test data.

## Installation

You can install the development version of scatools from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("mjz1/scatools")
```

## Example

We start by loading `scatools` and `ArchR`, as well as the filepath to an example `fragments.bed.gz` file containing fragments from 100 normal mammary cells. This bed file was generated using the `reformatFragmentFiles()` function from the `ArchR` package.

Note that all steps in this vignette work with a list of fragment files from multiple samples as well.
```{r setup, eval=TRUE, message=FALSE}
library(scatools)
library(ArchR, quietly = TRUE)
library(BSgenome.Hsapiens.UCSC.hg38, quietly = TRUE)
library(patchwork)
library(dittoSeq)
```


```{r, eval=FALSE}
ncores <- 4 # Adjust accordingly
addArchRThreads(ncores)
addArchRGenome("hg38")

fragment_file <- system.file("extdata", "fragments.bed.gz", package = "scatools")
names(fragment_file) <- "test_sample"
```


Now we process this data using `scatools`. Helper functions help us to create `GenomicRanges` bins, and compute GC content for downstream usage. Here we demonstrate using 10Mb bins.
```{r}
# Generate bins
bins <- get_tiled_bins(bs_genome = BSgenome.Hsapiens.UCSC.hg38::BSgenome.Hsapiens.UCSC.hg38, tilewidth = 1e7)
bin_name <- prettyMb(getmode(width(bins)))
```

A convenience wrapper is provided to perform the analysis
```{r, eval=FALSE}
sce <- run_scatools(sample_id = names(fragment_file), 
                    fragments = fragment_file, 
                    outdir = "./example/", 
                    verbose = TRUE, 
                    overwrite = FALSE, 
                    force_arrow = FALSE,
                    ncores = ncores, 
                    bins = bins)
```


```{r, include=FALSE}
# Sideload the SCE object
sce <- data(test_sce)
```


Plot the results using the `dittoSeq` package.
```{r}
p1 <- dittoDimPlot(sce, var = "clusters", do.label = TRUE, labels.highlight = FALSE, labels.repel = FALSE)
p2 <- dittoDimPlot(sce, var = "cnv_score", order = "increasing", legend.title = "cnv score")

pcomb <- p1 + p2 + plot_layout(ncol = 2) & theme(aspect.ratio = 1)
pcomb
```

```{r}
dittoPlot(sce, "cnv_score", group.by = "clusters", plots = c("vlnplot", "jitter"), jitter.width = 1, jitter.size = 0.2, x.labels.rotate = FALSE)
```



We can visualize the results as a heatmap.
```{r cnaheatmap_plot, message=FALSE}
ht <- cnaHeatmap(sce, assay_name = "counts_gc_modal", clone_name = "clusters", log2 = TRUE, center = TRUE, scale = "cells", col_fun = logr_col_fun(), col_clones = dittoColors(), border = TRUE)
ht
```


Or plot individual cells
```{r cell_cna_plot}
plot_cell_cna(sce = sce, cell_id = colnames(sce)[1:5], assay_name = "counts_gc_modal")
```
